{% extends 'base.html' %}
{% load static %}

{% block title %}
  {% if form.instance.id %}
    Edit {{ form.instance.year }} {{ form.instance.make.name }} {{ form.instance.model.name }}
  {% else %}
    Add New Car Listing
  {% endif %}
  - CarDealz
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2563eb;
        --primary-dark: #1d4ed8;
        --secondary-color: #f59e0b;
        --success-color: #10b981;
        --dark-color: #1f2937;
        --light-bg: #f8fafc;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    }

    /* Page Header */
    .page-header {
        background: var(--gradient-primary);
        color: white;
        padding: 3rem 0 2rem;
        margin-bottom: 0;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ffffff" fill-opacity="0.05" points="0,1000 1000,0 1000,1000"/></svg>');
        background-size: cover;
    }

    .page-header .container {
        position: relative;
        z-index: 2;
    }

    /* Breadcrumb */
    .breadcrumb {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
    }

    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
        color: white;
    }

    .breadcrumb-item.active {
        color: white;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.6);
        content: "â€º";
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Main Content */
    .main-content {
        margin-top: -2rem;
        position: relative;
        z-index: 10;
    }

    /* Form Sections */
    .form-section {
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .form-section:hover {
        box-shadow: var(--shadow-lg);
    }

    .form-section-header {
        background: var(--gradient-primary);
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .form-section-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .form-section-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
    }

    .form-section-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
    }

    .form-section-body {
        padding: 2rem;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .required-indicator {
        color: #dc2626;
        font-size: 1.1rem;
    }

    .form-control {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
    }

    .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
    }

    /* Help Text */
    .help-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .help-text::before {
        content: "\f05a";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        color: var(--primary-color);
        font-size: 0.75rem;
    }

    /* Error Messages */
    .invalid-feedback {
        display: block !important;
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background: #fef2f2;
        border-radius: 8px;
        border-left: 3px solid #dc2626;
    }

    /* Image Upload Section */
    .image-upload-section {
        background: var(--light-bg);
        border-radius: 16px;
        padding: 2rem;
        border: 2px dashed #d1d5db;
        transition: all 0.3s ease;
    }

    .image-upload-section:hover {
        border-color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
    }

    .image-formset {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .image-form-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
    }

    .image-form-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .image-preview-container {
        position: relative;
        height: 180px;
        background: var(--light-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .image-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-placeholder {
        color: #9ca3af;
        font-size: 3rem;
    }

    .image-form-body {
        padding: 1.5rem;
    }

    .primary-badge {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: var(--gradient-primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* File Input Styling */
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }

    .file-input-label {
        background: var(--gradient-primary);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        text-align: center;
    }

    .file-input-label:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    /* Checkboxes */
    .form-check {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--light-bg);
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .form-check:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .form-check-input {
        width: 18px;
        height: 18px;
        border: 2px solid #d1d5db;
        border-radius: 4px;
        margin: 0;
    }

    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .form-check-label {
        font-weight: 500;
        color: var(--dark-color);
        margin: 0;
        cursor: pointer;
    }

    .form-check-label.text-danger {
        color: #dc2626 !important;
    }

    /* Reconditioning Section */
    .recondition-section {
        transition: all 0.5s ease;
    }

    .recondition-section.hidden {
        opacity: 0;
        transform: translateY(-20px);
        pointer-events: none;
        margin-bottom: 0;
    }

    /* Action Buttons */
    .form-actions {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .btn-modern {
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .btn-primary-modern {
        background: var(--gradient-primary);
        color: white;
    }

    .btn-primary-modern:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white;
    }

    .btn-secondary-modern {
        background: #6b7280;
        color: white;
    }

    .btn-secondary-modern:hover {
        background: #4b5563;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white;
        text-decoration: none;
    }

    /* Progress Indicator */
    .form-progress {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        position: sticky;
        top: 120px;
        z-index: 100;
    }

    .progress-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--gradient-primary);
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .progress-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.5rem;
        text-align: center;
    }

    /* Form field animations */
    .form-control, .form-select {
        transition: all 0.3s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-control:hover, .form-select:hover {
        border-color: #9ca3af;
    }

    .form-group.focused {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }

    .form-group.focused .form-label {
        color: var(--primary-color);
    }

    /* Alert styles */
    .alert {
        border-radius: 12px;
        border: none;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
    }

    .alert-danger {
        background: linear-gradient(135deg, #fee2e2, #fca5a5);
        color: #991b1b;
    }

    .alert-info {
        background: linear-gradient(135deg, #dbeafe, #93c5fd);
        color: #1e40af;
    }

    .alert h6 {
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .alert ul {
        padding-left: 1.5rem;
    }

    .alert ul li {
        margin-bottom: 0.25rem;
    }

    /* Loading States */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }

    .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .form-section-body {
            padding: 1.5rem;
        }

        .main-content {
            margin-top: -1rem;
        }

        .page-header {
            padding: 2rem 0 1.5rem;
        }

        .form-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-modern {
            justify-content: center;
        }

        .image-formset {
            grid-template-columns: 1fr;
        }

        .form-section-header {
            padding: 1rem 1.5rem;
        }

        .form-section-title {
            font-size: 1.1rem;
        }
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Enhanced file input styling */
    .file-input-wrapper:hover .file-input-label {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
    }

    /* Better error state styling */
    .form-control:invalid, .form-select:invalid {
        border-color: #dc2626;
    }

    .form-control:valid, .form-select:valid {
        border-color: #10b981;
    }

    /* Improved checkbox styling */
    .form-check-input:checked {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3e%3cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd'/%3e%3c/svg%3e");
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'my-listings' %}">My Listings</a></li>
                <li class="breadcrumb-item active">
                    {% if form.instance.id %}Edit Car{% else %}Add Car{% endif %}
                </li>
            </ol>
        </nav>

        <!-- Page Title -->
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    {% if form.instance.id %}
                        <i class="fas fa-edit me-2"></i>Edit Your Car Listing
                    {% else %}
                        <i class="fas fa-plus-circle me-2"></i>Add New Car Listing
                    {% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if form.instance.id %}
                        Update the information for your {{ form.instance.year }} {{ form.instance.make.name }} {{ form.instance.model.name }}
                    {% else %}
                        Fill in the details below to create your professional car listing
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex align-items-center justify-content-md-end gap-3">
                    <i class="fas fa-info-circle" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container main-content">
    <!-- Progress Indicator -->
    <div class="form-progress animate-fade-in-up">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progressText">Complete all sections to publish your listing</div>
    </div>

    <form method="post" enctype="multipart/form-data" id="carForm">
        {% csrf_token %}

        <!-- Basic Information Section -->
        <div class="form-section animate-fade-in-up">
            <div class="form-section-header">
                <div class="form-section-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div>
                    <h3 class="form-section-title">Basic Information</h3>
                    <p class="form-section-subtitle">Essential details about your vehicle</p>
                </div>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.make.id_for_label }}" class="form-label">
                                <i class="fas fa-industry"></i>
                                Make
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.make }}
                            {% if form.make.errors %}
                                <div class="invalid-feedback">{{ form.make.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.model.id_for_label }}" class="form-label">
                                <i class="fas fa-car"></i>
                                Model
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.model }}
                            {% if form.model.errors %}
                                <div class="invalid-feedback">{{ form.model.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.year.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar-alt"></i>
                                Year
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.year }}
                            {% if form.year.errors %}
                                <div class="invalid-feedback">{{ form.year.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.car_type.id_for_label }}" class="form-label">
                                <i class="fas fa-tags"></i>
                                Car Type
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.car_type }}
                            {% if form.car_type.errors %}
                                <div class="invalid-feedback">{{ form.car_type.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.price.id_for_label }}" class="form-label">
                                <i class="fas fa-dollar-sign"></i>
                                Price
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.price }}
                            {% if form.price.errors %}
                                <div class="invalid-feedback">{{ form.price.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Specifications Section -->
        <div class="form-section animate-fade-in-up">
            <div class="form-section-header">
                <div class="form-section-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div>
                    <h3 class="form-section-title">Technical Specifications</h3>
                    <p class="form-section-subtitle">Engine, transmission, and performance details</p>
                </div>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.mileage.id_for_label }}" class="form-label">
                                <i class="fas fa-tachometer-alt"></i>
                                Mileage (km)
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.mileage }}
                            {% if form.mileage.help_text %}
                                <div class="help-text">{{ form.mileage.help_text }}</div>
                            {% endif %}
                            {% if form.mileage.errors %}
                                <div class="invalid-feedback">{{ form.mileage.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.engine_capacity.id_for_label }}" class="form-label">
                                <i class="fas fa-engine"></i>
                                Engine Capacity
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.engine_capacity }}
                            {% if form.engine_capacity.help_text %}
                                <div class="help-text">{{ form.engine_capacity.help_text }}</div>
                            {% endif %}
                            {% if form.engine_capacity.errors %}
                                <div class="invalid-feedback">{{ form.engine_capacity.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.transmission.id_for_label }}" class="form-label">
                                <i class="fas fa-cog"></i>
                                Transmission
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.transmission }}
                            {% if form.transmission.errors %}
                                <div class="invalid-feedback">{{ form.transmission.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.fuel_type.id_for_label }}" class="form-label">
                                <i class="fas fa-gas-pump"></i>
                                Fuel Type
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.fuel_type }}
                            {% if form.fuel_type.errors %}
                                <div class="invalid-feedback">{{ form.fuel_type.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.color.id_for_label }}" class="form-label">
                                <i class="fas fa-palette"></i>
                                Color
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.color }}
                            {% if form.color.errors %}
                                <div class="invalid-feedback">{{ form.color.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.doors.id_for_label }}" class="form-label">
                                <i class="fas fa-door-open"></i>
                                Doors
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.doors }}
                            {% if form.doors.errors %}
                                <div class="invalid-feedback">{{ form.doors.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.seats.id_for_label }}" class="form-label">
                                <i class="fas fa-users"></i>
                                Seats
                                <span class="required-indicator">*</span>
                            </label>
                            {{ form.seats }}
                            {% if form.seats.errors %}
                                <div class="invalid-feedback">{{ form.seats.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reconditioning Information Section -->
        <div class="form-section recondition-section animate-fade-in-up">
            <div class="form-section-header">
                <div class="form-section-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <div>
                    <h3 class="form-section-title">Reconditioning Information</h3>
                    <p class="form-section-subtitle">Details for reconditioned vehicles only</p>
                </div>
            </div>
            <div class="form-section-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.country_of_origin.id_for_label }}" class="form-label">
                                <i class="fas fa-globe"></i>
                                Country of Origin
                            </label>
                            {{ form.country_of_origin }}
                            {% if form.country_of_origin.errors %}
                                <div class="invalid-feedback">{{ form.country_of_origin.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.recondition_status.id_for_label }}" class="form-label">
                                <i class="fas fa-wrench"></i>
                                Reconditioning Status
                            </label>
                            {{ form.recondition_status }}
                            {% if form.recondition_status.help_text %}
                                <div class="help-text">{{ form.recondition_status.help_text }}</div>
                            {% endif %}
                            {% if form.recondition_status.errors %}
                                <div class="invalid-feedback">{{ form.recondition_status.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description & Features Section -->
        <div class="form-section animate-fade-in-up">
            <div class="form-section-header">
                <div class="form-section-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div>
                    <h3 class="form-section-title">Description & Features</h3>
                    <p class="form-section-subtitle">Detailed information and features list</p>
                </div>
            </div>
            <div class="form-section-body">
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        <i class="fas fa-align-left"></i>
                        Description
                        <span class="required-indicator">*</span>
                    </label>
                    {{ form.description }}
                    <div class="help-text">Provide a detailed description of your vehicle's condition, history, and selling points</div>
                    {% if form.description.errors %}
                        <div class="invalid-feedback">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.features.id_for_label }}" class="form-label">
                        <i class="fas fa-star"></i>
                        Features
                        <span class="required-indicator">*</span>
                    </label>
                    {{ form.features }}
                    {% if form.features.help_text %}
                        <div class="help-text">{{ form.features.help_text }}</div>
                    {% else %}
                        <div class="help-text">List key features, one per line (e.g., Air Conditioning, Power Windows, Bluetooth)</div>
                    {% endif %}
                    {% if form.features.errors %}
                        <div class="invalid-feedback">{{ form.features.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Car Images Section -->
        <div class="form-section animate-fade-in-up">
            <div class="form-section-header">
                <div class="form-section-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <div>
                    <h3 class="form-section-title">Car Images</h3>
                    <p class="form-section-subtitle">Upload high-quality photos of your vehicle</p>
                </div>
            </div>
            <div class="form-section-body">
                <div class="image-upload-section">
                    {{ formset.management_form }}

                    <div class="image-formset" id="image-formset">
                        {% for form in formset.forms %}
                            <div class="image-form-card formset-row">
                                <div class="image-preview-container">
                                    {% if form.instance.image %}
                                        <img src="{{ form.instance.image.url }}" class="image-preview" alt="Car Image">
                                        {% if form.instance.is_primary %}
                                            <div class="primary-badge">Primary</div>
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-image image-placeholder"></i>
                                    {% endif %}
                                </div>
                                <div class="image-form-body">
                                    {{ form.id }}

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-upload"></i>
                                            Choose Image
                                        </label>
                                        <div class="file-input-wrapper">
                                            {{ form.image }}
                                            <label for="{{ form.image.id_for_label }}" class="file-input-label">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                Select Image
                                            </label>
                                        </div>
                                        {% if form.image.errors %}
                                            <div class="invalid-feedback">{{ form.image.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="form-check">
                                        {{ form.is_primary }}
                                        <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                            <i class="fas fa-star me-1"></i>
                                            Set as primary image
                                        </label>
                                    </div>

                                    {% if formset.can_delete %}
                                        <div class="form-check">
                                            {{ form.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                                <i class="fas fa-trash me-1"></i>
                                                Delete this image
                                            </label>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="mt-3">
                        <div class="help-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Upload multiple angles: front, back, interior, engine bay. First image will be the main photo.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEO Section -->
        <div class="form-section animate-fade-in-up">
            <div class="form-section-header">
                <div class="form-section-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div>
                    <h3 class="form-section-title">SEO & URL</h3>
                    <p class="form-section-subtitle">Search engine optimization settings</p>
                </div>
            </div>
            <div class="form-section-body">
                <div class="form-group">
                    <label for="{{ form.slug.id_for_label }}" class="form-label">
                        <i class="fas fa-link"></i>
                        URL Slug
                    </label>
                    {{ form.slug }}
                    <div class="help-text">
                        Will be auto-generated from make, model, and year if left empty (e.g., 2022-toyota-camry)
                    </div>
                    {% if form.slug.errors %}
                        <div class="invalid-feedback">{{ form.slug.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions animate-fade-in-up">
            <div>
                <a href="{% url 'my-listings' %}" class="btn-modern btn-secondary-modern">
                    <i class="fas fa-arrow-left"></i>
                    Back to Listings
                </a>
            </div>
            <div>
                <button type="submit" class="btn-modern btn-primary-modern" id="submitBtn">
                    <i class="fas fa-save"></i>
                    {% if form.instance.id %}Update Listing{% else %}Create Listing{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Bootstrap classes to form elements
        const formControls = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="url"], select, textarea');
        formControls.forEach(element => {
            if (!element.classList.contains('form-check-input')) {
                element.classList.add('form-control');
            }
        });

        // Add Bootstrap classes to select elements
        const selectElements = document.querySelectorAll('select');
        selectElements.forEach(select => {
            select.classList.remove('form-control');
            select.classList.add('form-select');
        });

        // Form validation and progress tracking
        const form = document.getElementById('carForm');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const submitBtn = document.getElementById('submitBtn');
        const reconditionSection = document.querySelector('.recondition-section');
        const carTypeSelect = document.querySelector('#id_car_type');

        // Required fields for progress calculation
        const requiredFields = [
            '#id_make', '#id_model', '#id_year', '#id_car_type', '#id_price',
            '#id_mileage', '#id_engine_capacity', '#id_transmission', '#id_fuel_type',
            '#id_color', '#id_doors', '#id_seats', '#id_description', '#id_features'
        ];

        // Toggle reconditioning fields
        function toggleReconditionFields() {
            if (carTypeSelect && carTypeSelect.value === 'reconditioned') {
                reconditionSection.classList.remove('hidden');
            } else {
                reconditionSection.classList.add('hidden');
            }
        }

        // Calculate form progress
        function updateProgress() {
            let completedFields = 0;
            const totalFields = requiredFields.length;

            requiredFields.forEach(selector => {
                const field = document.querySelector(selector);
                if (field && field.value.trim() !== '') {
                    completedFields++;
                }
            });

            const progress = Math.round((completedFields / totalFields) * 100);
            progressFill.style.width = progress + '%';

            if (progress === 100) {
                progressText.textContent = 'All required fields completed! Ready to publish.';
                progressText.style.color = '#10b981';
            } else {
                progressText.textContent = `${completedFields}/${totalFields} required fields completed (${progress}%)`;
                progressText.style.color = '#6b7280';
            }
        }

        // Initialize
        if (carTypeSelect) {
            toggleReconditionFields();
            carTypeSelect.addEventListener('change', toggleReconditionFields);
        }

        // Update progress on field changes
        requiredFields.forEach(selector => {
            const field = document.querySelector(selector);
            if (field) {
                field.addEventListener('input', updateProgress);
                field.addEventListener('change', updateProgress);
            }
        });

        // Initial progress calculation
        updateProgress();

        // Handle primary image selection
        const primaryCheckboxes = document.querySelectorAll('input[id$="-is_primary"]');
        primaryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    primaryCheckboxes.forEach(cb => {
                        if (cb !== this) {
                            cb.checked = false;
                            // Remove primary badge from other images
                            const card = cb.closest('.image-form-card');
                            const badge = card.querySelector('.primary-badge');
                            if (badge) {
                                badge.remove();
                            }
                        }
                    });

                    // Add primary badge to selected image
                    const card = this.closest('.image-form-card');
                    const container = card.querySelector('.image-preview-container');
                    let badge = container.querySelector('.primary-badge');
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'primary-badge';
                        badge.textContent = 'Primary';
                        container.appendChild(badge);
                    }
                }
            });
        });

        // File input change handlers
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function() {
                const file = this.files[0];
                const card = this.closest('.image-form-card');
                const container = card.querySelector('.image-preview-container');
                const placeholder = container.querySelector('.image-placeholder');
                let preview = container.querySelector('.image-preview');

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (preview) {
                            preview.src = e.target.result;
                        } else {
                            preview = document.createElement('img');
                            preview.className = 'image-preview';
                            preview.src = e.target.result;
                            preview.alt = 'Car Image Preview';

                            if (placeholder) {
                                container.replaceChild(preview, placeholder);
                            } else {
                                container.appendChild(preview);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // Form validation summary
        function showValidationSummary() {
            const errors = [];
            const requiredFieldsData = [
                { id: '#id_make', name: 'Make' },
                { id: '#id_model', name: 'Model' },
                { id: '#id_year', name: 'Year' },
                { id: '#id_car_type', name: 'Car Type' },
                { id: '#id_price', name: 'Price' },
                { id: '#id_mileage', name: 'Mileage' },
                { id: '#id_engine_capacity', name: 'Engine Capacity' },
                { id: '#id_transmission', name: 'Transmission' },
                { id: '#id_fuel_type', name: 'Fuel Type' },
                { id: '#id_color', name: 'Color' },
                { id: '#id_doors', name: 'Doors' },
                { id: '#id_seats', name: 'Seats' },
                { id: '#id_description', name: 'Description' },
                { id: '#id_features', name: 'Features' }
            ];

            requiredFieldsData.forEach(field => {
                const element = document.querySelector(field.id);
                if (element && !element.value.trim()) {
                    errors.push(field.name);
                }
            });

            if (errors.length > 0) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger mb-3';
                errorMsg.innerHTML = `
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Please complete the following required fields:</h6>
                    <ul class="mb-0 mt-2">
                        ${errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                `;

                // Remove existing error message
                const existingError = document.querySelector('.alert-danger');
                if (existingError) {
                    existingError.remove();
                }

                // Insert at top of form
                form.insertBefore(errorMsg, form.firstChild);

                // Scroll to top
                errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });

                return false;
            }

            return true;
        }

        // Enhanced form submission
        form.addEventListener('submit', function(e) {
            // Validate form before submission
            if (!showValidationSummary()) {
                e.preventDefault();
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
                return;
            }

            // Show loading state
            submitBtn.classList.add('btn-loading');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            // Update progress to 100%
            progressFill.style.width = '100%';
            progressText.textContent = 'Submitting your listing...';
            progressText.style.color = '#10b981';
        });

        // Image upload enhancements
        const imageCards = document.querySelectorAll('.image-form-card');
        imageCards.forEach((card, index) => {
            const deleteCheckbox = card.querySelector('input[name$="-DELETE"]');

            if (deleteCheckbox) {
                deleteCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        card.style.opacity = '0.5';
                        card.style.pointerEvents = 'none';
                    } else {
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                    }
                });
            }
        });

        // Field focus effects
        const allFormFields = document.querySelectorAll('.form-control, .form-select');
        allFormFields.forEach(field => {
            field.addEventListener('focus', function() {
                this.closest('.form-group').classList.add('focused');
            });

            field.addEventListener('blur', function() {
                this.closest('.form-group').classList.remove('focused');
            });
        });

        // Auto-resize textareas
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            // Set initial rows
            if (textarea.id === 'id_description') {
                textarea.rows = 6;
            } else if (textarea.id === 'id_features') {
                textarea.rows = 6;
            }

            // Auto-resize on input
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // Price formatting
        const priceInput = document.querySelector('#id_price');
        if (priceInput) {
            priceInput.addEventListener('input', function() {
                // Remove non-numeric characters except decimal point
                let value = this.value.replace(/[^0-9.]/g, '');

                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                this.value = value;
            });
        }

        // Auto-generate slug
        const makeSelect = document.querySelector('#id_make');
        const modelSelect = document.querySelector('#id_model');
        const yearInput = document.querySelector('#id_year');
        const slugInput = document.querySelector('#id_slug');

        function generateSlug() {
            if (slugInput && !slugInput.value && makeSelect && modelSelect && yearInput) {
                const make = makeSelect.options[makeSelect.selectedIndex]?.text || '';
                const model = modelSelect.options[modelSelect.selectedIndex]?.text || '';
                const year = yearInput.value || '';

                if (make && model && year) {
                    const slug = `${year}-${make}-${model}`
                        .toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim('-');

                    slugInput.value = slug;
                }
            }
        }

        if (makeSelect) makeSelect.addEventListener('change', generateSlug);
        if (modelSelect) modelSelect.addEventListener('change', generateSlug);
        if (yearInput) yearInput.addEventListener('input', generateSlug);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }

            // Escape to go back
            if (e.key === 'Escape') {
                const backBtn = document.querySelector('.btn-secondary-modern');
                if (backBtn) {
                    window.location.href = backBtn.href;
                }
            }
        });

        // Smooth scroll animations
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-fade-in-up');
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        });

        document.querySelectorAll('.form-section').forEach((el) => {
            observer.observe(el);
        });

        // Field validation on blur
        requiredFields.forEach(selector => {
            const field = document.querySelector(selector);
            if (field) {
                field.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.style.borderColor = '#dc2626';
                        this.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
                    } else {
                        this.style.borderColor = '#10b981';
                        this.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';

                        // Reset to normal after a short delay
                        setTimeout(() => {
                            this.style.borderColor = '';
                            this.style.boxShadow = '';
                        }, 2000);
                    }
                });
            }
        });

        console.log('Modern car form initialized successfully');
    });
</script>
{% endblock %}